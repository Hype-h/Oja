<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Sign In - Oja Marketplace</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="logo">
      <img src="./public/logo.png" alt="Oja Logo" class="logo-img" onerror="this.src='https://placehold.co/200x60/f59e0b/ffffff?text=OJA+LOGO'">
    </div>
    <ul class="nav-links">
      <li><a href="./index.html">Home</a></li>
      <li><a href="./products.html">Browse</a></li>
    </ul>
    <div class="nav-right">
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">Back</button>
    </div>
  </nav>

  <!-- Alerts -->
  <div class="alert alert-success hidden" id="successAlert"></div>
  <div class="alert alert-error hidden" id="errorAlert"></div>

  <!-- Auth Container -->
  <div class="container padded">
    <div class="auth-container">
      <!-- Login Form -->
      <div id="loginForm" class="active">
        <h2 class="auth-title">Customer Sign In</h2>
        <p class="auth-subtitle">Sign in to your customer account</p>
        
        <form onsubmit="customerLogin(event)">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required placeholder="Enter your email">
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" required minlength="6" placeholder="Enter your password">
          </div>
          <button type="submit" class="btn btn-primary full-width mt-1">Sign In</button>
        </form>

        <div class="auth-link">
          Don't have an account? <a href="#" onclick="showRegisterForm()">Register</a>
        </div>
        <div class="auth-link">
          <a href="./vendor-auth.html">Sign in as Vendor</a> | 
          <a href="./admin-auth.html">Admin Login</a>
        </div>
      </div>

      <!-- Register Form -->
      <div id="registerForm" style="display: none;">
        <h2 class="auth-title">Create Customer Account</h2>
        <p class="auth-subtitle">Join our marketplace today</p>
        
        <form onsubmit="customerRegister(event)">
          <div class="form-group">
            <label for="registerName">Full Name</label>
            <input type="text" id="registerName" required placeholder="Enter your full name">
          </div>
          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" required placeholder="Enter your email">
          </div>
          <div class="form-group">
            <label for="registerPassword">Password</label>
            <input type="password" id="registerPassword" required minlength="6" placeholder="Create a password (min 6 characters)">
          </div>
          <button type="submit" class="btn btn-primary full-width mt-1">Create Account</button>
        </form>

        <div class="auth-link">
          Already have an account? <a href="#" onclick="showLoginForm()">Sign In</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <script>
    // ====== FIREBASE CONFIGURATION ======
    const firebaseConfig = {
    apiKey: "AIzaSyALSSw0-d0F2-Zkj5aXVN1ip7FcMCouy8Q",
    authDomain: "oja-place01.firebaseapp.com",
    projectId: "oja-place01",
    storageBucket: "oja-place01.firebasestorage.app",
    messagingSenderId: "543711721814",
    appId: "1:543711721814:web:6fafe8a7cf1db4b3493ef7"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ====== FORM FUNCTIONS ======
    function showLoginForm() {
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("registerForm").style.display = "none";
    }

    function showRegisterForm() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    }

    // ====== ALERT FUNCTION ======
    function showAlert(msg, type = "success") {
      const id = type === "success" ? "successAlert" : "errorAlert";
      const el = document.getElementById(id);
      if (el) {
        el.textContent = msg;
        el.classList.remove("hidden");
        setTimeout(() => el.classList.add("hidden"), 3000);
      }
    }

    // ====== LOGIN FUNCTION ======
    async function customerLogin(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) {
        showAlert("Please fill in all fields", "error");
        return;
      }

      try {
        // Disable button and show loading
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.textContent = "Signing In...";
        btn.disabled = true;

        const result = await auth.signInWithEmailAndPassword(email, password);
        
        // Check if customer role
        const userDoc = await db.collection("users").doc(result.user.uid).get();
        if (userDoc.exists && userDoc.data().role === "customer") {
          showAlert("Login successful!");
          setTimeout(() => window.location.href = "./customer-dashboard.html", 1000);
        } else {
          showAlert("Invalid customer account", "error");
          await auth.signOut();
          btn.textContent = originalText;
          btn.disabled = false;
        }
      } catch (error) {
        console.error("Login error:", error);
        let errorMessage = "Login failed";
        
        switch (error.code) {
          case "auth/user-not-found":
            errorMessage = "No account found with this email";
            break;
          case "auth/wrong-password":
            errorMessage = "Incorrect password";
            break;
          case "auth/invalid-email":
            errorMessage = "Invalid email address";
            break;
          case "auth/too-many-requests":
            errorMessage = "Too many attempts. Try again later";
            break;
          default:
            errorMessage = error.message;
        }
        
        showAlert(errorMessage, "error");
        
        // Re-enable button
        const btn = e.target.querySelector('button[type="submit"]');
        btn.textContent = "Sign In";
        btn.disabled = false;
      }
    }

    // ====== REGISTER FUNCTION ======
    async function customerRegister(e) {
      e.preventDefault();
      const name = document.getElementById("registerName").value.trim();
      const email = document.getElementById("registerEmail").value.trim();
      const password = document.getElementById("registerPassword").value;

      if (!name || !email || !password) {
        showAlert("Please fill in all fields", "error");
        return;
      }

      if (password.length < 6) {
        showAlert("Password must be at least 6 characters", "error");
        return;
      }

      try {
        // Disable button and show loading
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.textContent = "Creating Account...";
        btn.disabled = true;

        const result = await auth.createUserWithEmailAndPassword(email, password);
        
        await db.collection("users").doc(result.user.uid).set({
          name: name,
          email: email,
          role: "customer",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          phone: "",
          profileComplete: false
        });

        showAlert("Account created successfully!");
        setTimeout(() => {
          showLoginForm();
          document.getElementById("loginEmail").value = email;
          btn.textContent = originalText;
          btn.disabled = false;
        }, 1500);
      } catch (error) {
        console.error("Registration error:", error);
        let errorMessage = "Registration failed";
        
        switch (error.code) {
          case "auth/email-already-in-use":
            errorMessage = "Email already registered";
            break;
          case "auth/invalid-email":
            errorMessage = "Invalid email address";
            break;
          case "auth/weak-password":
            errorMessage = "Password is too weak";
            break;
          case "auth/operation-not-allowed":
            errorMessage = "Email/password accounts are not enabled";
            break;
          default:
            errorMessage = error.message;
        }
        
        showAlert(errorMessage, "error");
        
        // Re-enable button
        const btn = e.target.querySelector('button[type="submit"]');
        btn.textContent = "Create Account";
        btn.disabled = false;
      }
    }

    // ====== CHECK IF ALREADY LOGGED IN ======
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          const userDoc = await db.collection("users").doc(user.uid).get();
          if (userDoc.exists && userDoc.data().role === "customer") {
            showAlert("Welcome back! Redirecting...");
            setTimeout(() => window.location.href = "./customer-dashboard.html", 1000);
          }
        } catch (error) {
          console.error("Error checking user role:", error);
        }
      }
    });

    // ====== FORM VALIDATION ENHANCEMENTS ======
    document.addEventListener('DOMContentLoaded', function() {
      // Email validation
      const emailInputs = document.querySelectorAll('input[type="email"]');
      emailInputs.forEach(input => {
        input.addEventListener('blur', function() {
          if (this.value && !this.validity.valid) {
            this.style.borderColor = 'var(--error)';
          } else if (this.value) {
            this.style.borderColor = 'var(--success)';
          }
        });
      });

      // Password validation
      const passwordInputs = document.querySelectorAll('input[type="password"]');
      passwordInputs.forEach(input => {
        input.addEventListener('input', function() {
          if (this.value.length > 0 && this.value.length < 6) {
            this.style.borderColor = 'var(--error)';
          } else if (this.value.length >= 6) {
            this.style.borderColor = 'var(--success)';
          }
        });
      });

      // Auto-focus first input
      const firstInput = document.querySelector('.form-group input');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 300);
      }
    });
  </script>
</body>
</html>