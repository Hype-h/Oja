<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Oja Marketplace</title>
    <link rel="icon" type="image/x-icon" href="./public/favicon.ico">
    <link rel="stylesheet" href="./checkout.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="./customer-dashboard.html">
                    <img src="./public/logo.png" alt="Oja Logo" class="logo-img">
                </a>
            </div>
            <div class="nav-menu">
                <a href="./customer-dashboard.html" class="nav-link">Home</a>
                <a href="./products.html" class="nav-link">Products</a>
                <a href="cart.html" class="nav-link active">Cart <span id="cart-count" class="cart-badge">0</span></a>
                <button id="user-menu-btn" class="nav-link">Account</button>
            </div>
        </div>
    </nav>

    <!-- Cart Header -->
    <div class="cart-header">
        <h1>Shopping Cart</h1>
        <p id="cart-item-count">0 items in your cart</p>
    </div>

    <!-- Cart Content -->
    <div class="cart-content">
        <!-- Cart Items Section -->
        <div class="cart-items-section">
            <!-- Empty State -->
            <div id="empty-cart-message" class="empty-state">
                <p>Your cart is empty</p>
                <a href="./products.html" class="btn btn-primary">Continue Shopping</a>
            </div>
            
            <!-- Cart Items -->
            <div id="cart-items" class="cart-items"></div>
        </div>

        <!-- Cart Summary Sidebar -->
        <div class="cart-summary">
            <h2>Order Summary</h2>
            
            <!-- Vendor Groups -->
            <div id="vendor-groups" class="vendor-groups"></div>
            
            <!-- Summary Section -->
            <div class="summary-section">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal-amount">‚Ç¶0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax (7.5%)</span>
                    <span id="tax-amount">‚Ç¶0.00</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span id="shipping-amount">‚Ç¶0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="cart-total">‚Ç¶0.00</span>
                </div>
            </div>
            
            <!-- Checkout Section -->
            <div class="checkout-section">
                <label class="checkbox">
                    <input type="checkbox" id="terms-checkbox">
                    <span>I agree to the terms and conditions</span>
                </label>
                
                <button id="checkout-btn" class="btn btn-primary btn-large" disabled>
                    <span>Place Order</span>
                </button>
                
                <button id="continue-shopping-btn" class="btn btn-secondary btn-large">
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>

    <!-- User Menu Modal -->
    <div id="user-menu-modal" class="modal">
        <div class="modal-content user-menu">
            <span class="close">&times;</span>
            <div id="user-logged-out" class="menu-section">
                <h3>Welcome to Oja</h3>
                <p>Sign in to access your account</p>
                <a href="customer-auth.html" class="btn-primary user-menu-btn">Sign In</a>
                <a href="customer-auth.html?register=true" class="btn-secondary user-menu-btn">Create Account</a>
            </div>
            <div id="user-logged-in" class="menu-section menu-section-hidden">
                <h3>My Account</h3>
                <p id="user-email" class="user-email-text"></p>
                <a href="customer-dashboard.html" class="menu-link">üìä My Dashboard</a>
                <a href="customer-orders.html" class="menu-link">üì¶ My Orders</a>
                <a href="customer-reviews.html" class="menu-link">‚≠ê My Reviews</a>
                <a href="customer-addresses.html" class="menu-link">üìç My Addresses</a>
                <hr class="menu-divider">
                <button id="logout-btn" class="menu-link logout-btn">üö™ Logout</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // ====== FIREBASE CONFIGURATION ======
        const firebaseConfig = {
          apiKey: "AIzaSyALSSw0-d0F2-Zkj5aXVN1ip7FcMCouy8Q",
          authDomain: "oja-place01.firebaseapp.com",
          projectId: "oja-place01",
          storageBucket: "oja-place01.firebasestorage.app",
          messagingSenderId: "543711721814",
          appId: "1:543711721814:web:6fafe8a7cf1db4b3493ef7"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ====== GLOBAL VARIABLES ======
        let currentUser = null;
        let cart = [];
        const TAX_RATE = 0.075;
        const SHIPPING_FEE = 500;

        // ====== DOM ELEMENTS ======
        const elements = {
            cartItems: document.getElementById('cart-items'),
            emptyCartMessage: document.getElementById('empty-cart-message'),
            cartCount: document.getElementById('cart-count'),
            cartItemCount: document.getElementById('cart-item-count'),
            subtotalAmount: document.getElementById('subtotal-amount'),
            taxAmount: document.getElementById('tax-amount'),
            shippingAmount: document.getElementById('shipping-amount'),
            cartTotal: document.getElementById('cart-total'),
            vendorGroups: document.getElementById('vendor-groups'),
            checkoutBtn: document.getElementById('checkout-btn'),
            continueShoppingBtn: document.getElementById('continue-shopping-btn'),
            termsCheckbox: document.getElementById('terms-checkbox'),
            userMenuBtn: document.getElementById('user-menu-btn'),
            userMenuModal: document.getElementById('user-menu-modal'),
            closeModalBtn: document.querySelector('.close'),
            userLoggedOut: document.getElementById('user-logged-out'),
            userLoggedIn: document.getElementById('user-logged-in'),
            userEmail: document.getElementById('user-email'),
            logoutBtn: document.getElementById('logout-btn')
        };

        // ====== INITIALIZATION ======
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            loadCart();
            setupEventListeners();
        });

        // ====== CART FUNCTIONS ======
        function loadCart() {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            displayCart();
            updateSummary();
        }

        function displayCart() {
            elements.cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                elements.emptyCartMessage.classList.remove('hidden');
                elements.cartItems.parentElement.classList.add('hidden');
                elements.cartCount.textContent = '0';
                elements.cartItemCount.textContent = '0 items in your cart';
                return;
            }
            
            elements.emptyCartMessage.classList.add('hidden');
            elements.cartItems.parentElement.classList.remove('hidden');
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            elements.cartCount.textContent = totalItems;
            elements.cartItemCount.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''} in your cart`;
            
            cart.forEach(item => {
                const cartItem = createCartItemElement(item);
                elements.cartItems.appendChild(cartItem);
            });
            
            displayVendorGroups();
        }

        function createCartItemElement(item) {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.dataset.id = item.id;
            
            const itemTotal = (item.price * item.quantity).toFixed(2);
            
            div.innerHTML = `
                <div class="item-image">
                    <img src="${item.image || 'https://placehold.co/120x120/e5e7eb/6b7280?text=Product'}" 
                         alt="${item.name}">
                </div>
                <div class="item-details">
                    <h3>${item.name}</h3>
                    <p class="item-vendor">${item.vendorName || 'Unknown Vendor'}</p>
                    <p class="item-price">${item.price.toFixed(2)}</p>
                </div>
                <div class="item-quantity">
                    <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)" 
                            ${item.quantity <= 1 ? 'disabled' : ''}>‚àí</button>
                    <input type="number" value="${item.quantity}" min="1" 
                           onchange="setQuantity('${item.id}', this.value)" readonly>
                    <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                </div>
                <div class="item-total">
                    <p>$${itemTotal}</p>
                </div>
                <button class="remove-btn" onclick="removeFromCart('${item.id}')" 
                        aria-label="Remove ${item.name}">√ó</button>
            `;
            
            return div;
        }

        function displayVendorGroups() {
            const vendorMap = new Map();
            
            cart.forEach(item => {
                const vendorName = item.vendorName || 'Unknown Vendor';
                if (!vendorMap.has(vendorName)) {
                    vendorMap.set(vendorName, []);
                }
                vendorMap.get(vendorName).push(item);
            });
            
            elements.vendorGroups.innerHTML = '';
            
            vendorMap.forEach((items, vendorName) => {
                const itemCount = items.reduce((sum, item) => sum + item.quantity, 0);
                const vendorDiv = document.createElement('div');
                vendorDiv.className = 'vendor-group';
                vendorDiv.innerHTML = `
                    <h4>${vendorName}</h4>
                    <p>${itemCount} item${itemCount !== 1 ? 's' : ''}</p>
                `;
                elements.vendorGroups.appendChild(vendorDiv);
            });
        }

        function updateQuantity(productId, change) {
            const item = cart.find(i => i.id === productId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            saveCart();
            displayCart();
            updateSummary();
        }

        function setQuantity(productId, value) {
            const quantity = parseInt(value);
            if (isNaN(quantity) || quantity < 1) return;
            
            const item = cart.find(i => i.id === productId);
            if (!item) return;
            
            item.quantity = quantity;
            saveCart();
            displayCart();
            updateSummary();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            displayCart();
            updateSummary();
            showAlert('Item removed from cart', 'success');
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function updateSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const shipping = cart.length > 0 ? SHIPPING_FEE : 0;
            const total = subtotal + tax + shipping;
            
            elements.subtotalAmount.textContent = `‚Ç¶${subtotal.toFixed(2)}`;
            elements.taxAmount.textContent = `‚Ç¶${tax.toFixed(2)}`;
            elements.shippingAmount.textContent = `‚Ç¶${shipping.toFixed(2)}`;
            elements.cartTotal.textContent = `‚Ç¶${total.toFixed(2)}`;
        }

        // ====== CHECKOUT FUNCTIONS ======
        async function checkout() {
            if (!currentUser) {
                showAlert('Please sign in to checkout', 'error');
                window.location.href = 'customer-auth.html';
                return;
            }
            
            if (cart.length === 0) {
                showAlert('Your cart is empty', 'error');
                return;
            }
            
            if (!elements.termsCheckbox.checked) {
                showAlert('Please agree to the terms and conditions', 'error');
                return;
            }
            
            elements.checkoutBtn.disabled = true;
            elements.checkoutBtn.innerHTML = '<span>Processing...</span>';
            
            try {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const tax = subtotal * TAX_RATE;
                const shipping = SHIPPING_FEE;
                const total = subtotal + tax + shipping;
                
                const order = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    items: cart,
                    subtotal: subtotal,
                    tax: tax,
                    shipping: shipping,
                    total: total,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('orders').add(order);
                
                localStorage.removeItem('cart');
                cart = [];
                
                showAlert('Order placed successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'customer-orders.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error placing order:', error);
                showAlert('Failed to place order. Please try again.', 'error');
                elements.checkoutBtn.disabled = false;
                elements.checkoutBtn.innerHTML = '<span>Place Order</span>';
            }
        }

        // ====== AUTH FUNCTIONS ======
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateUserMenu(user);
            });
        }

        function updateUserMenu(user) {
            if (user) {
                elements.userLoggedOut.classList.add('menu-section-hidden');
                elements.userLoggedIn.classList.remove('menu-section-hidden');
                elements.userEmail.textContent = user.email || 'User';
            } else {
                elements.userLoggedOut.classList.remove('menu-section-hidden');
                elements.userLoggedIn.classList.add('menu-section-hidden');
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showAlert('Logged out successfully', 'success');
                closeUserMenu();
            } catch (error) {
                console.error('Error logging out:', error);
                showAlert('Failed to logout', 'error');
            }
        }

        function openUserMenu() {
            elements.userMenuModal.classList.add('modal-show');
        }

        function closeUserMenu() {
            elements.userMenuModal.classList.remove('modal-show');
        }

        // ====== EVENT LISTENERS ======
        function setupEventListeners() {
            elements.checkoutBtn.addEventListener('click', checkout);
            
            elements.continueShoppingBtn.addEventListener('click', () => {
                window.location.href = './products.html';
            });
            
            elements.termsCheckbox.addEventListener('change', (e) => {
                elements.checkoutBtn.disabled = !e.target.checked || cart.length === 0;
            });
            
            elements.userMenuBtn.addEventListener('click', openUserMenu);
            elements.closeModalBtn.addEventListener('click', closeUserMenu);
            elements.logoutBtn.addEventListener('click', logout);
            
            window.addEventListener('click', (e) => {
                if (e.target === elements.userMenuModal) {
                    closeUserMenu();
                }
            });
        }

        // ====== UTILITY FUNCTIONS ======
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-fixed`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>