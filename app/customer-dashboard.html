<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account - Oja Marketplace</title>
  <link rel="stylesheet" href="./customer.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="dashboard-nav">
    <div class="nav-container-flex">
      <div class="logo">
        <img src="./public/logo.png" alt="Oja" class="logo-img">
      </div>
      <ul class="nav-links">
        <li><a href="./products.html" class="nav-link-item">
          <span class="nav-icon">üè™</span>
          <span>Browse</span>
        </a></li>
        <li><a href="./customer-dashboard.html" class="nav-link-item active">
          <span class="nav-icon">üë§</span>
          <span>My Account</span>
        </a></li>
      </ul>
      <div class="nav-right-actions">
        <div class="cart-icon-wrapper" onclick="toggleCart()">
          <span class="cart-icon">üõí</span>
          <span id="cartCount" class="cart-badge hidden">0</span>
        </div>
        <div class="user-menu-dropdown">
          <button class="user-menu-btn" onclick="toggleUserMenu()">
            <span class="user-avatar">
              <span id="userInitials">U</span>
            </span>
            <span id="customerName" class="customer-name-display"></span>
            <span class="dropdown-arrow">‚ñº</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <div class="dropdown-user-info">
              <div class="dropdown-avatar">
                <span id="dropdownInitials">U</span>
              </div>
              <div class="dropdown-user-details">
                <p class="dropdown-name" id="dropdownName">User</p>
                <p class="dropdown-email" id="dropdownEmail">user@email.com</p>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <button class="dropdown-menu-item" onclick="showTab('profile', event)">
              <span class="dropdown-item-icon">‚öôÔ∏è</span>
              <span>Settings</span>
            </button>
            <button class="dropdown-menu-item" onclick="logout()">
              <span class="dropdown-item-icon">üö™</span>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Toast Notifications -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Dashboard Content -->
  <div class="dashboard-wrapper">
    <!-- Sidebar Navigation -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-title">My Account</h2>
      </div>
      <nav class="sidebar-nav">
        <button class="sidebar-nav-item active" data-tab="overview" onclick="showTab('overview', event)">
          <span class="sidebar-icon">üìä</span>
          <span>Overview</span>
        </button>
        <button class="sidebar-nav-item" data-tab="orders" onclick="showTab('orders', event)">
          <span class="sidebar-icon">üì¶</span>
          <span>My Orders</span>
          <span class="sidebar-badge" id="ordersBadge">0</span>
        </button>
        <button class="sidebar-nav-item" data-tab="profile" onclick="showTab('profile', event)">
          <span class="sidebar-icon">üë§</span>
          <span>Profile</span>
        </button>
        <button class="sidebar-nav-item" data-tab="addresses" onclick="showTab('addresses', event)">
          <span class="sidebar-icon">üìç</span>
          <span>Addresses</span>
        </button>
        <button class="sidebar-nav-item" data-tab="security" onclick="showTab('security', event)">
          <span class="sidebar-icon">üîí</span>
          <span>Security</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="dashboard-main">
      <!-- Overview Tab -->
      <div id="tabOverview" class="tab-content-section active">
        <div class="content-header">
          <div>
            <h1 class="content-title">Welcome Back, <span id="welcomeName">User</span>!</h1>
            <p class="content-subtitle">Here's what's happening with your account</p>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card-modern stat-card-gradient-purple">
            <div class="stat-card-icon">
              <span>üì¶</span>
            </div>
            <div class="stat-card-content">
              <p class="stat-label">Total Orders</p>
              <h3 class="stat-value" id="statTotalOrders">0</h3>
              <p class="stat-change positive">+2 this month</p>
            </div>
          </div>

          <div class="stat-card-modern stat-card-gradient-pink">
            <div class="stat-card-icon">
              <span>‚è≥</span>
            </div>
            <div class="stat-card-content">
              <p class="stat-label">Pending Orders</p>
              <h3 class="stat-value" id="statPendingOrders">0</h3>
              <p class="stat-change neutral">Awaiting processing</p>
            </div>
          </div>

          <div class="stat-card-modern stat-card-gradient-blue">
            <div class="stat-card-icon">
              <span>‚úÖ</span>
            </div>
            <div class="stat-card-content">
              <p class="stat-label">Delivered</p>
              <h3 class="stat-value" id="statDeliveredOrders">0</h3>
              <p class="stat-change positive">All time</p>
            </div>
          </div>

          <div class="stat-card-modern stat-card-gradient-orange">
            <div class="stat-card-icon">
              <span>üí∞</span>
            </div>
            <div class="stat-card-content">
              <p class="stat-label">Total Spent</p>
              <h3 class="stat-value" id="statTotalSpent">$0.00</h3>
              <p class="stat-change neutral">Lifetime value</p>
            </div>
          </div>
        </div>

        <!-- Recent Orders Section -->
        <div class="dashboard-section-card">
          <div class="section-card-header">
            <div>
              <h2 class="section-card-title">Recent Orders</h2>
              <p class="section-card-subtitle">Your latest purchases</p>
            </div>
            <button class="btn-link" onclick="showTab('orders', event)">View All ‚Üí</button>
          </div>
          <div id="recentOrdersList" class="recent-orders-list">
            <div class="loading-spinner">
              <div class="spinner"></div>
              <p class="loading-text">Loading orders...</p>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-grid">
          <button class="quick-action-card" onclick="window.location.href='./products.html'">
            <span class="quick-action-icon">üõçÔ∏è</span>
            <div>
              <h3 class="quick-action-title">Continue Shopping</h3>
              <p class="quick-action-desc">Browse our products</p>
            </div>
          </button>
          <button class="quick-action-card" onclick="showTab('addresses', event)">
            <span class="quick-action-icon">üìç</span>
            <div>
              <h3 class="quick-action-title">Manage Addresses</h3>
              <p class="quick-action-desc">Update delivery locations</p>
            </div>
          </button>
          <button class="quick-action-card" onclick="showTab('profile', event)">
            <span class="quick-action-icon">‚öôÔ∏è</span>
            <div>
              <h3 class="quick-action-title">Account Settings</h3>
              <p class="quick-action-desc">Update your profile</p>
            </div>
          </button>
        </div>
      </div>

      <!-- Orders Tab -->
      <div id="tabOrders" class="tab-content-section">
        <div class="content-header">
          <div>
            <h1 class="content-title">My Orders</h1>
            <p class="content-subtitle">Track and manage your orders</p>
          </div>
        </div>

        <!-- Order Filters -->
        <div class="filter-bar">
          <button class="filter-chip active" data-filter="all" onclick="filterOrders('all', event)">
            <span>All Orders</span>
          </button>
          <button class="filter-chip" data-filter="pending" onclick="filterOrders('pending', event)">
            <span>Pending</span>
          </button>
          <button class="filter-chip" data-filter="processing" onclick="filterOrders('processing', event)">
            <span>Processing</span>
          </button>
          <button class="filter-chip" data-filter="shipped" onclick="filterOrders('shipped', event)">
            <span>Shipped</span>
          </button>
          <button class="filter-chip" data-filter="delivered" onclick="filterOrders('delivered', event)">
            <span>Delivered</span>
          </button>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="orders-list-container">
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Loading orders...</p>
          </div>
        </div>
      </div>

      <!-- Profile Tab -->
      <div id="tabProfile" class="tab-content-section">
        <div class="content-header">
          <div>
            <h1 class="content-title">Profile Information</h1>
            <p class="content-subtitle">Manage your personal details</p>
          </div>
        </div>

        <div class="profile-grid">
          <div class="profile-card">
            <div class="profile-card-header">
              <h2 class="profile-card-title">Personal Information</h2>
            </div>
            <form onsubmit="updateProfile(event)" class="profile-form">
              <div class="form-group-modern">
                <label for="profileName" class="form-label-modern">Full Name</label>
                <input type="text" id="profileName" class="form-input-modern" placeholder="Enter your full name" required>
              </div>
              <div class="form-group-modern">
                <label for="profileEmail" class="form-label-modern">Email Address</label>
                <input type="email" id="profileEmail" class="form-input-modern" readonly disabled>
                <p class="form-hint">Email cannot be changed</p>
              </div>
              <div class="form-group-modern">
                <label for="profilePhone" class="form-label-modern">Phone Number</label>
                <input type="tel" id="profilePhone" class="form-input-modern" placeholder="+1 (555) 000-0000">
              </div>
              <button type="submit" class="btn-primary-modern">
                <span>Save Changes</span>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Security Tab -->
      <div id="tabSecurity" class="tab-content-section">
        <div class="content-header">
          <div>
            <h1 class="content-title">Security Settings</h1>
            <p class="content-subtitle">Keep your account secure</p>
          </div>
        </div>

        <div class="profile-grid">
          <div class="profile-card">
            <div class="profile-card-header">
              <h2 class="profile-card-title">Change Password</h2>
            </div>
            <form onsubmit="changePassword(event)" class="profile-form">
              <div class="form-group-modern">
                <label for="currentPassword" class="form-label-modern">Current Password</label>
                <input type="password" id="currentPassword" class="form-input-modern" placeholder="Enter current password" required minlength="6">
              </div>
              <div class="form-group-modern">
                <label for="newPassword" class="form-label-modern">New Password</label>
                <input type="password" id="newPassword" class="form-input-modern" placeholder="Enter new password" required minlength="6">
              </div>
              <div class="form-group-modern">
                <label for="confirmPassword" class="form-label-modern">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-input-modern" placeholder="Confirm new password" required minlength="6">
              </div>
              <button type="submit" class="btn-primary-modern">
                <span>Update Password</span>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Addresses Tab -->
      <div id="tabAddresses" class="tab-content-section">
        <div class="content-header">
          <div>
            <h1 class="content-title">Saved Addresses</h1>
            <p class="content-subtitle">Manage your delivery locations</p>
          </div>
          <button class="btn-primary-modern" onclick="showAddAddressModal()">
            <span>+ Add Address</span>
          </button>
        </div>

        <div id="addressesList" class="addresses-grid-modern">
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Loading addresses...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderDetailModal" class="modal-overlay-modern" onclick="if(event.target === this) closeOrderDetailModal()">
    <div class="modal-content-modern" onclick="event.stopPropagation()">
      <div class="modal-header-modern">
        <h2 class="modal-title-modern">Order Details</h2>
        <button class="modal-close-btn" onclick="closeOrderDetailModal()">‚úï</button>
      </div>
      <div class="modal-body-modern" id="orderDetailContent">
        <!-- Order details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add Address Modal -->
  <div id="addAddressModal" class="modal-overlay-modern" onclick="if(event.target === this) closeAddAddressModal()">
    <div class="modal-content-modern modal-content-medium" onclick="event.stopPropagation()">
      <div class="modal-header-modern">
        <h2 class="modal-title-modern">Add New Address</h2>
        <button class="modal-close-btn" onclick="closeAddAddressModal()">‚úï</button>
      </div>
      <div class="modal-body-modern">
        <form onsubmit="addAddress(event)" class="address-form">
          <div class="form-group-modern">
            <label for="addressLabel" class="form-label-modern">Address Label</label>
            <input type="text" id="addressLabel" class="form-input-modern" placeholder="e.g., Home, Office" required>
          </div>
          <div class="form-group-modern">
            <label for="addressStreet" class="form-label-modern">Street Address</label>
            <input type="text" id="addressStreet" class="form-input-modern" placeholder="123 Main Street" required>
          </div>
          <div class="form-row-2">
            <div class="form-group-modern">
              <label for="addressCity" class="form-label-modern">City</label>
              <input type="text" id="addressCity" class="form-input-modern" placeholder="New York" required>
            </div>
            <div class="form-group-modern">
              <label for="addressState" class="form-label-modern">State/Province</label>
              <input type="text" id="addressState" class="form-input-modern" placeholder="NY" required>
            </div>
          </div>
          <div class="form-row-2">
            <div class="form-group-modern">
              <label for="addressCountry" class="form-label-modern">Country</label>
              <input type="text" id="addressCountry" class="form-input-modern" placeholder="United States" required>
            </div>
            <div class="form-group-modern">
              <label for="addressPostal" class="form-label-modern">Postal Code</label>
              <input type="text" id="addressPostal" class="form-input-modern" placeholder="10001" required>
            </div>
          </div>
          <div class="modal-footer-modern">
            <button type="button" class="btn-secondary-modern" onclick="closeAddAddressModal()">Cancel</button>
            <button type="submit" class="btn-primary-modern">Save Address</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Cart Sidebar -->
  <aside class="cart-sidebar-modern" id="cartSidebar">
    <div class="cart-header-modern">
      <h3 class="cart-title">Shopping Cart</h3>
      <button class="modal-close-btn" onclick="toggleCart()">‚úï</button>
    </div>
    <div class="cart-items-container" id="cartItems"></div>
    <div id="cartEmpty" class="cart-empty-state">
      <p class="cart-empty-icon">üõí</p>
      <p class="cart-empty-text">Your cart is empty</p>
      <button class="btn-secondary-modern" onclick="window.location.href='./products.html'">Start Shopping</button>
    </div>
    <div id="cartFooter" class="cart-footer-modern hidden">
      <div class="cart-summary-modern">
        <div class="summary-row-modern">
          <span>Subtotal</span>
          <span id="cartSubtotal">$0.00</span>
        </div>
        <div class="summary-row-modern total">
          <span>Total</span>
          <span id="cartTotalPrice">$0.00</span>
        </div>
      </div>
      <button class="btn-primary-modern full-width" onclick="checkout()">
        <span>Proceed to Checkout</span>
      </button>
      <button class="btn-secondary-modern full-width" onclick="toggleCart()">Continue Shopping</button>
    </div>
  </aside>

  <!-- Cart Overlay -->
  <div class="cart-overlay-modern" id="cartOverlay" onclick="toggleCart()"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <!-- App Scripts -->
  <script src="./js/firebase-config.js"></script>
  <script>
    let currentCustomer = null;
    let allOrders = [];
    let currentFilter = 'all';
    const App = { cart: [] };

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
      toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
      `;
      
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function toggleUserMenu() {
      const menu = document.getElementById('userDropdownMenu');
      menu.classList.toggle('show');
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-menu-dropdown')) {
        document.getElementById('userDropdownMenu')?.classList.remove('show');
      }
    });

    async function logout() {
      if (!confirm("Are you sure you want to logout?")) return;
      try {
        await auth.signOut();
        window.location.href = "customer-auth.html";
      } catch (error) {
        console.error("Logout error:", error);
        showToast("Failed to logout", "error");
      }
    }

    function showTab(tabName, event) {
      document.querySelectorAll(".tab-content-section").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".sidebar-nav-item").forEach(el => el.classList.remove("active"));
      
      const tabElement = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
      if (tabElement) tabElement.classList.add("active");
      
      const navItem = document.querySelector(`[data-tab="${tabName}"]`);
      if (navItem) navItem.classList.add("active");
    }

    async function loadDashboard() {
      if (!currentCustomer) return;

      try {
        const userDoc = await db.collection("users").doc(currentCustomer.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const name = userData.name || "User";
          const email = userData.email || "";
          
          document.getElementById("customerName").textContent = name;
          document.getElementById("welcomeName").textContent = name;
          document.getElementById("dropdownName").textContent = name;
          document.getElementById("dropdownEmail").textContent = email;
          
          const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          document.getElementById("userInitials").textContent = initials;
          document.getElementById("dropdownInitials").textContent = initials;
          
          document.getElementById("profileName").value = name;
          document.getElementById("profileEmail").value = email;
          document.getElementById("profilePhone").value = userData.phone || "";
        }

        await loadOrders();
        await loadAddresses();
        updateStats();
      } catch (error) {
        console.error("Error loading dashboard:", error);
        showToast("Failed to load dashboard", "error");
      }
    }

    async function loadOrders() {
      const ordersListEl = document.getElementById("ordersList");
      const recentOrdersEl = document.getElementById("recentOrdersList");
      
      try {
        const ordersSnap = await db.collection("orders")
          .where("customerId", "==", currentCustomer.uid)
          .orderBy("createdAt", "desc")
          .get();

        allOrders = ordersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        displayOrders(allOrders);
        displayRecentOrders(allOrders.slice(0, 3));
        
        const pendingCount = allOrders.filter(o => o.status === 'pending').length;
        const badge = document.getElementById('ordersBadge');
        if (badge) {
          badge.textContent = pendingCount;
          badge.style.display = pendingCount > 0 ? 'flex' : 'none';
        }
      } catch (error) {
        console.error("Error loading orders:", error);
        ordersListEl.innerHTML = '<div class="empty-state-modern">Failed to load orders. Please try again.</div>';
      }
    }

    function displayRecentOrders(orders) {
      const el = document.getElementById("recentOrdersList");
      if (orders.length === 0) {
        el.innerHTML = '<div class="empty-state-modern">No orders yet. Start shopping!</div>';
        return;
      }

      el.innerHTML = orders.map(order => {
        const date = order.createdAt?.toDate?.() || new Date();
        return `
          <div class="recent-order-item" onclick="viewOrderDetails('${order.id}')">
            <div class="recent-order-icon">üì¶</div>
            <div class="recent-order-info">
              <h4 class="recent-order-id">Order #${order.id.substring(0, 8).toUpperCase()}</h4>
              <p class="recent-order-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
            </div>
            <div class="recent-order-details">
              <span class="order-status-badge status-${order.status}">${order.status}</span>
              <p class="recent-order-total">$${order.total.toFixed(2)}</p>
            </div>
          </div>
        `;
      }).join("");
    }

    function displayOrders(orders) {
      const el = document.getElementById("ordersList");
      if (orders.length === 0) {
        el.innerHTML = '<div class="empty-state-modern"><div class="empty-icon">üì¶</div><h3>No orders found</h3><p>Start shopping to see your orders here</p><button class="btn-primary-modern" onclick="window.location.href=\'./products.html\'">Browse Products</button></div>';
        return;
      }

      el.innerHTML = orders.map(order => {
        const date = order.createdAt?.toDate?.() || new Date();
        return `
          <div class="order-card-modern">
            <div class="order-card-header-modern">
              <div class="order-header-left">
                <div class="order-icon-circle">üì¶</div>
                <div>
                  <h3 class="order-id-modern">Order #${order.id.substring(0, 8).toUpperCase()}</h3>
                  <p class="order-date-modern">${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
              </div>
              <span class="order-status-badge status-${order.status}">${order.status}</span>
            </div>
            <div class="order-card-body-modern">
              <div class="order-items-preview">
                ${order.items.slice(0, 3).map(item => `
                  <div class="order-item-preview">
                    <span class="item-bullet">‚Ä¢</span>
                    <span>${item.productName} √ó ${item.quantity}</span>
                  </div>
                `).join("")}
                ${order.items.length > 3 ? `<p class="order-more-items">+${order.items.length - 3} more items</p>` : ''}
              </div>
            </div>
            <div class="order-card-footer-modern">
              <div class="order-total-modern">
                <span class="total-label">Total:</span>
                <span class="total-amount">$${order.total.toFixed(2)}</span>
              </div>
              <button class="btn-secondary-modern btn-sm" onclick="viewOrderDetails('${order.id}')">View Details</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function filterOrders(status, event) {
      currentFilter = status;
      
      document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (event && event.target.closest('.filter-chip')) {
        event.target.closest('.filter-chip').classList.add('active');
      }
      
      if (status === 'all') {
        displayOrders(allOrders);
      } else {
        const filtered = allOrders.filter(o => o.status === status);
        displayOrders(filtered);
      }
    }

    async function viewOrderDetails(orderId) {
      try {
        const orderDoc = await db.collection("orders").doc(orderId).get();
        if (!orderDoc.exists) {
          showToast("Order not found", "error");
          return;
        }

        const order = { id: orderDoc.id, ...orderDoc.data() };
        const date = order.createdAt?.toDate?.() || new Date();

        document.getElementById("orderDetailContent").innerHTML = `
          <div class="order-detail-section">
            <div class="order-detail-header-modern">
              <div>
                <h3 class="order-detail-id-modern">Order #${order.id.substring(0, 8).toUpperCase()}</h3>
                <p class="order-detail-date-modern">Placed on ${date.toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'short' })}</p>
              </div>
              <span class="order-status-badge status-${order.status}">${order.status}</span>
            </div>

            <div class="order-detail-grid">
              <div class="order-detail-card">
                <h4 class="detail-card-title">Order Summary</h4>
                <div class="detail-info-row">
                  <span class="detail-label">Total Amount:</span>
                  <span class="detail-value">$${order.total.toFixed(2)}</span>
                </div>
                <div class="detail-info-row">
                  <span class="detail-label">Items:</span>
                  <span class="detail-value">${order.items.length}</span>
                </div>
              </div>

              ${order.shippingAddress ? `
                <div class="order-detail-card">
                  <h4 class="detail-card-title">Shipping Address</h4>
                  <p class="address-detail-line">${order.shippingAddress.street || ''}</p>
                  <p class="address-detail-line">${order.shippingAddress.city || ''}, ${order.shippingAddress.state || ''}</p>
                  <p class="address-detail-line">${order.shippingAddress.country || ''} ${order.shippingAddress.postal || ''}</p>
                </div>
              ` : ''}
            </div>

            <div class="order-items-section">
              <h4 class="order-items-title-modern">Order Items</h4>
              <div class="order-items-list-modern">
                ${order.items.map(item => `
                  <div class="order-item-detail-card">
                    <div class="order-item-detail-info">
                      <h5 class="item-detail-name">${item.productName}</h5>
                      <p class="item-detail-vendor">by ${item.vendorName || 'Unknown Vendor'}</p>
                      <p class="item-detail-qty">Quantity: ${item.quantity}</p>
                    </div>
                    <div class="item-detail-price">${(item.price * item.quantity).toFixed(2)}</div>
                  </div>
                `).join("")}
              </div>
            </div>
          </div>
        `;

        document.getElementById("orderDetailModal").style.display = "flex";
      } catch (error) {
        console.error("Error loading order details:", error);
        showToast("Failed to load order details", "error");
      }
    }

    function closeOrderDetailModal() {
      document.getElementById("orderDetailModal").style.display = "none";
    }

    async function updateProfile(e) {
      e.preventDefault();
      const name = document.getElementById("profileName").value.trim();
      const phone = document.getElementById("profilePhone").value.trim();

      if (!name) {
        showToast("Name is required", "error");
        return;
      }

      try {
        await db.collection("users").doc(currentCustomer.uid).update({
          name: name,
          phone: phone,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast("Profile updated successfully!");
        
        document.getElementById("customerName").textContent = name;
        document.getElementById("welcomeName").textContent = name;
        document.getElementById("dropdownName").textContent = name;
        
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        document.getElementById("userInitials").textContent = initials;
        document.getElementById("dropdownInitials").textContent = initials;
      } catch (error) {
        console.error("Error updating profile:", error);
        showToast("Failed to update profile", "error");
      }
    }

    async function changePassword(e) {
      e.preventDefault();
      const currentPass = document.getElementById("currentPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;

      if (newPass !== confirmPass) {
        showToast("New passwords do not match", "error");
        return;
      }

      if (newPass.length < 6) {
        showToast("Password must be at least 6 characters", "error");
        return;
      }

      try {
        const credential = firebase.auth.EmailAuthProvider.credential(
          currentCustomer.email,
          currentPass
        );
        await currentCustomer.reauthenticateWithCredential(credential);
        await currentCustomer.updatePassword(newPass);
        
        showToast("Password changed successfully!");
        e.target.reset();
      } catch (error) {
        console.error("Error changing password:", error);
        if (error.code === 'auth/wrong-password') {
          showToast("Current password is incorrect", "error");
        } else {
          showToast(error.message, "error");
        }
      }
    }

    async function loadAddresses() {
      const addressesListEl = document.getElementById("addressesList");
      try {
        const addressesSnap = await db.collection("addresses")
          .where("customerId", "==", currentCustomer.uid)
          .get();

        const addresses = addressesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayAddresses(addresses);
      } catch (error) {
        console.error("Error loading addresses:", error);
        addressesListEl.innerHTML = '<div class="empty-state-modern">Failed to load addresses. Please try again.</div>';
      }
    }

    function displayAddresses(addresses) {
      const el = document.getElementById("addressesList");
      if (addresses.length === 0) {
        el.innerHTML = '<div class="empty-state-modern"><div class="empty-icon">üìç</div><h3>No saved addresses</h3><p>Add a delivery address to get started</p><button class="btn-primary-modern" onclick="showAddAddressModal()">+ Add Address</button></div>';
        return;
      }

      el.innerHTML = addresses.map(addr => `
        <div class="address-card-modern">
          <div class="address-card-header-modern">
            <div class="address-icon-circle">üìç</div>
            <h3 class="address-label-modern">${addr.label}</h3>
          </div>
          <div class="address-card-body-modern">
            <p class="address-line-modern">${addr.street}</p>
            <p class="address-line-modern">${addr.city}, ${addr.state}</p>
            <p class="address-line-modern">${addr.country} ${addr.postal}</p>
          </div>
          <div class="address-card-footer-modern">
            <button class="btn-danger-modern btn-sm" onclick="deleteAddress('${addr.id}')">
              <span>üóëÔ∏è</span>
              <span>Delete</span>
            </button>
          </div>
        </div>
      `).join("");
    }

    function showAddAddressModal() {
      document.getElementById("addAddressModal").style.display = "flex";
    }

    function closeAddAddressModal() {
      document.getElementById("addAddressModal").style.display = "none";
      const form = document.querySelector("#addAddressModal form");
      if (form) form.reset();
    }

    async function addAddress(e) {
      e.preventDefault();

      const addressData = {
        customerId: currentCustomer.uid,
        label: document.getElementById("addressLabel").value.trim(),
        street: document.getElementById("addressStreet").value.trim(),
        city: document.getElementById("addressCity").value.trim(),
        state: document.getElementById("addressState").value.trim(),
        country: document.getElementById("addressCountry").value.trim(),
        postal: document.getElementById("addressPostal").value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("addresses").add(addressData);
        showToast("Address added successfully!");
        closeAddAddressModal();
        loadAddresses();
      } catch (error) {
        console.error("Error adding address:", error);
        showToast("Failed to add address", "error");
      }
    }

    async function deleteAddress(addressId) {
      if (!confirm("Are you sure you want to delete this address?")) return;

      try {
        await db.collection("addresses").doc(addressId).delete();
        showToast("Address deleted successfully!");
        loadAddresses();
      } catch (error) {
        console.error("Error deleting address:", error);
        showToast("Failed to delete address", "error");
      }
    }

    function updateStats() {
      const totalOrders = allOrders.length;
      const pendingOrders = allOrders.filter(o => o.status === 'pending').length;
      const deliveredOrders = allOrders.filter(o => o.status === 'delivered').length;
      const totalSpent = allOrders.reduce((sum, o) => sum + (o.total || 0), 0);

      document.getElementById('statTotalOrders').textContent = totalOrders;
      document.getElementById('statPendingOrders').textContent = pendingOrders;
      document.getElementById('statDeliveredOrders').textContent = deliveredOrders;
      document.getElementById('statTotalSpent').textContent = `${totalSpent.toFixed(2)}`;
    }

    function toggleCart() {
      const sidebar = document.getElementById("cartSidebar");
      const overlay = document.getElementById("cartOverlay");
      
      if (sidebar && overlay) {
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
      }
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById("cartItems");
      const cartEmpty = document.getElementById("cartEmpty");
      const cartFooter = document.getElementById("cartFooter");
      const cartCount = document.getElementById("cartCount");

      if (App.cart.length === 0) {
        if (cartItems) cartItems.innerHTML = '';
        if (cartEmpty) cartEmpty.style.display = 'flex';
        if (cartFooter) cartFooter.classList.add('hidden');
        if (cartCount) cartCount.classList.add('hidden');
      } else {
        if (cartEmpty) cartEmpty.style.display = 'none';
        if (cartFooter) cartFooter.classList.remove('hidden');
        if (cartCount) {
          cartCount.textContent = App.cart.length;
          cartCount.classList.remove('hidden');
        }
        
        if (cartItems) {
          const total = App.cart.reduce((sum, item) => sum + parseFloat(item.price), 0);
          cartItems.innerHTML = App.cart.map(item => `
            <div class="cart-item-modern">
              <div class="cart-item-icon">üõçÔ∏è</div>
              <div class="cart-item-info-modern">
                <p class="cart-item-name-modern">${item.name}</p>
                <p class="cart-item-price-modern">${item.price}</p>
              </div>
            </div>
          `).join('');
          
          document.getElementById('cartSubtotal').textContent = `${total.toFixed(2)}`;
          document.getElementById('cartTotalPrice').textContent = `${total.toFixed(2)}`;
        }
      }
    }

    async function checkout() {
      if (App.cart.length === 0) {
        showToast("Your cart is empty", "error");
        return;
      }
      showToast("Redirecting to checkout...");
      window.location.href = "./checkout.html";
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "./customer-auth.html";
        return;
      }

      try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists || userDoc.data().role !== "customer") {
          showToast("Access denied. Customer account required.", "error");
          await auth.signOut();
          window.location.href = "./index.html";
          return;
        }

        currentCustomer = user;
        loadDashboard();
        updateCartDisplay();
      } catch (error) {
        console.error("Auth error:", error);
        showToast("Authentication error", "error");
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeOrderDetailModal();
        closeAddAddressModal();
        document.getElementById('userDropdownMenu')?.classList.remove('show');
      }
    });
  </script>
</body>
</html>