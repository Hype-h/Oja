<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Oja Marketplace</title>
  <link rel="stylesheet" href="./admin-dashboard.css">
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="logo">
      <img src="./public/logo.png" alt="Oja" class="logo-img">
    </div>
    <ul class="nav-links">
      <li><a href="./index.html">Home</a></li>
      <li><a href="./admin-dashboard.html" class="active">Admin Panel</a></li>
    </ul>
    <div class="nav-right">
      <span id="admin-name">Admin</span>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </nav>

  <!-- Alerts -->
  <div class="alert alert-success hidden" id="successAlert"></div>
  <div class="alert alert-error hidden" id="errorAlert"></div>

  <!-- Dashboard Content -->
  <div class="dashboard-container">
    <h1 class="section-title">Admin Dashboard</h1>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="quick-action-btn" onclick="showTab('vendors')">
        <span>ðŸ‘¥</span> Manage Vendors
      </button>
      <button class="quick-action-btn" onclick="showTab('orders')">
        <span>ðŸ“¦</span> View Orders
      </button>
      <button class="quick-action-btn" onclick="showTab('products')">
        <span>ðŸ“Š</span> Manage Products
      </button>
      <button class="quick-action-btn" onclick="showTab('users')">
        <span>ðŸ‘¤</span> View Users
      </button>
    </div>

    <!-- Stats -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <h3>Total Users</h3>
        <p class="stat-value" id="totalUsers">0</p>
      </div>
      <div class="stat-card">
        <h3>Active Vendors</h3>
        <p class="stat-value" id="activeVendors">0</p>
      </div>
      <div class="stat-card">
        <h3>Total Products</h3>
        <p class="stat-value" id="totalProducts">0</p>
      </div>
      <div class="stat-card">
        <h3>Total Orders</h3>
        <p class="stat-value" id="totalOrders">0</p>
      </div>
      <div class="stat-card">
        <h3>Total Revenue</h3>
        <p class="stat-value" id="totalRevenue">$0.00</p>
      </div>
      <div class="stat-card alert-card">
        <h3>Pending Vendors</h3>
        <p class="stat-value" id="pendingVendors">0</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <button class="tab-btn active" onclick="showTab('vendors')">Pending Vendors</button>
      <button class="tab-btn" onclick="showTab('orders')">Orders</button>
      <button class="tab-btn" onclick="showTab('products')">Products</button>
      <button class="tab-btn" onclick="showTab('users')">Users</button>
    </div>

    <!-- Pending Vendors Tab -->
    <div id="tabVendors" class="tab-content">
      <h2>Pending Vendor Applications</h2>
      <div id="pendingVendorsList">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading pending vendors...</p>
        </div>
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="tabOrders" class="tab-content" style="display: none;">
      <h2>All Orders</h2>
      <div id="ordersList">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading orders...</p>
        </div>
      </div>
    </div>

    <!-- Products Tab -->
    <div id="tabProducts" class="tab-content" style="display: none;">
      <h2>All Products</h2>
      <div id="productsList">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading products...</p>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="tabUsers" class="tab-content" style="display: none;">
      <h2>All Users</h2>
      <div id="usersList">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading users...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <script>
    // ====== FIREBASE CONFIGURATION ======
    const firebaseConfig = {
      apiKey: "AIzaSyALSSw0-d0F2-Zkj5aXVN1ip7FcMCouy8Q",
      authDomain: "oja-place01.firebaseapp.com",
      projectId: "oja-place01",
      storageBucket: "oja-place01.firebasestorage.app",
      messagingSenderId: "543711721814",
      appId: "1:543711721814:web:6fafe8a7cf1db4b3493ef7"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ====== GLOBAL VARIABLES ======
    let currentAdmin = null;
    let dashboardData = {
      users: [],
      vendors: [],
      products: [],
      orders: []
    };

    // ====== UTILITY FUNCTIONS ======
    function showAlert(message, type = 'success') {
      const id = type === 'success' ? 'successAlert' : 'errorAlert';
      const el = document.getElementById(id);
      
      if (el) {
        el.textContent = message;
        el.className = `alert alert-${type}`;
        el.classList.remove('hidden');
        
        setTimeout(() => {
          el.classList.add('hidden');
        }, 3000);
      }
    }

    // ====== AUTH FUNCTIONS ======
    async function logout() {
      try {
        await auth.signOut();
        showAlert('Logged out successfully');
        setTimeout(() => window.location.href = 'admin-auth.html', 1000);
      } catch (error) {
        console.error('Error logging out:', error);
        showAlert('Failed to logout', 'error');
      }
    }

    // ====== TAB FUNCTIONS ======
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(el => {
        el.style.display = 'none';
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('active');
      });
      
      // Show selected tab
      const tabId = `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
      document.getElementById(tabId).style.display = 'block';
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Load tab data if needed
      if (tabName === 'vendors' && dashboardData.vendors.length > 0) {
        displayPendingVendors();
      } else if (tabName === 'orders' && dashboardData.orders.length > 0) {
        displayOrders();
      } else if (tabName === 'products' && dashboardData.products.length > 0) {
        displayProducts();
      } else if (tabName === 'users' && dashboardData.users.length > 0) {
        displayUsers();
      }
    }

    // ====== DASHBOARD LOADING ======
    async function loadDashboard() {
      try {
        // Load all data in parallel
        const [usersSnapshot, vendorsSnapshot, productsSnapshot, ordersSnapshot] = await Promise.all([
          db.collection('users').get(),
          db.collection('users').where('role', '==', 'vendor').get(),
          db.collection('products').get(),
          db.collection('orders').get()
        ]);

        // Process data
        dashboardData.users = usersSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        dashboardData.vendors = vendorsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        dashboardData.products = productsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        dashboardData.orders = ordersSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // Update stats
        updateDashboardStats();
        
        // Display initial tab (pending vendors)
        displayPendingVendors();

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showAlert('Failed to load dashboard data', 'error');
        
        // Load sample data for demo
        loadSampleData();
      }
    }

    function loadSampleData() {
      // Sample data for demo purposes
      dashboardData = {
        users: [
          { id: '1', name: 'John Doe', email: 'john@example.com', role: 'customer', createdAt: { toDate: () => new Date() } },
          { id: '2', name: 'Jane Smith', email: 'jane@example.com', role: 'customer', createdAt: { toDate: () => new Date() } },
          { id: '3', businessName: 'Tech Store', email: 'tech@store.com', role: 'vendor', status: 'approved', createdAt: { toDate: () => new Date() } },
          { id: '4', businessName: 'Pending Shop', email: 'pending@shop.com', role: 'vendor', status: 'pending', createdAt: { toDate: () => new Date() } }
        ],
        vendors: [
          { id: '3', businessName: 'Tech Store', email: 'tech@store.com', role: 'vendor', status: 'approved', createdAt: { toDate: () => new Date() } },
          { id: '4', businessName: 'Pending Shop', email: 'pending@shop.com', role: 'vendor', status: 'pending', createdAt: { toDate: () => new Date() } }
        ],
        products: [
          { id: '1', name: 'Smartphone', price: 499.99, vendorName: 'Tech Store', stock: 50, category: 'electronics' },
          { id: '2', name: 'Laptop', price: 899.99, vendorName: 'Tech Store', stock: 25, category: 'electronics' }
        ],
        orders: [
          { id: '1', total: 499.99, customerEmail: 'john@example.com', status: 'delivered', createdAt: { toDate: () => new Date() } },
          { id: '2', total: 899.99, customerEmail: 'jane@example.com', status: 'processing', createdAt: { toDate: () => new Date() } }
        ]
      };

      updateDashboardStats();
      displayPendingVendors();
    }

    function updateDashboardStats() {
      const { users, vendors, products, orders } = dashboardData;
      
      // Total users
      document.getElementById('totalUsers').textContent = users.length;
      
      // Active vendors (approved)
      const activeVendors = vendors.filter(v => v.status === 'approved');
      document.getElementById('activeVendors').textContent = activeVendors.length;
      
      // Pending vendors
      const pendingVendors = vendors.filter(v => v.status === 'pending');
      document.getElementById('pendingVendors').textContent = pendingVendors.length;
      
      // Total products
      document.getElementById('totalProducts').textContent = products.length;
      
      // Total orders
      document.getElementById('totalOrders').textContent = orders.length;
      
      // Total revenue
      const revenue = orders.reduce((total, order) => total + (order.total || 0), 0);
      document.getElementById('totalRevenue').textContent = `$${revenue.toFixed(2)}`;
    }

    // ====== DISPLAY FUNCTIONS ======
    function displayPendingVendors() {
      const container = document.getElementById('pendingVendorsList');
      const pendingVendors = dashboardData.vendors.filter(v => v.status === 'pending');
      
      if (pendingVendors.length === 0) {
        container.innerHTML = '<div class="empty-state">No pending vendor applications</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="admin-table">
          <thead>
            <tr>
              <th>Business Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Applied On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${pendingVendors.map(vendor => `
              <tr>
                <td>${vendor.businessName || 'N/A'}</td>
                <td>${vendor.email || 'N/A'}</td>
                <td>${vendor.phone || 'N/A'}</td>
                <td>${vendor.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-primary btn-sm" onclick="approveVendor('${vendor.id}')">
                      Approve
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="rejectVendor('${vendor.id}')">
                      Reject
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function displayOrders() {
      const container = document.getElementById('ordersList');
      const orders = dashboardData.orders;
      
      if (orders.length === 0) {
        container.innerHTML = '<div class="empty-state">No orders found</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="admin-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Total</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(order => `
              <tr>
                <td>#${order.id.substring(0, 8)}</td>
                <td>${order.customerEmail || 'N/A'}</td>
                <td>$${(order.total || 0).toFixed(2)}</td>
                <td>
                  <span class="status-badge status-${order.status || 'pending'}">
                    ${(order.status || 'pending').toUpperCase()}
                  </span>
                </td>
                <td>${order.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function displayProducts() {
      const container = document.getElementById('productsList');
      const products = dashboardData.products;
      
      if (products.length === 0) {
        container.innerHTML = '<div class="empty-state">No products found</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="admin-table">
          <thead>
            <tr>
              <th>Product Name</th>
              <th>Vendor</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${products.map(product => `
              <tr>
                <td>${product.name || 'N/A'}</td>
                <td>${product.vendorName || 'N/A'}</td>
                <td>$${(product.price || 0).toFixed(2)}</td>
                <td>${product.stock || 0}</td>
                <td>${product.category || 'Uncategorized'}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function displayUsers() {
      const container = document.getElementById('usersList');
      const users = dashboardData.users;
      
      if (users.length === 0) {
        container.innerHTML = '<div class="empty-state">No users found</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="admin-table">
          <thead>
            <tr>
              <th>Name/Business</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Joined</th>
            </tr>
          </thead>
          <tbody>
            ${users.map(user => `
              <tr>
                <td>${user.name || user.businessName || 'N/A'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>
                  <span class="role-badge role-${user.role || 'customer'}">
                    ${(user.role || 'customer').toUpperCase()}
                  </span>
                </td>
                <td>
                  <span class="status-badge status-${user.status || 'active'}">
                    ${(user.status || 'active').toUpperCase()}
                  </span>
                </td>
                <td>${user.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ====== ADMIN ACTIONS ======
    async function approveVendor(vendorId) {
      if (!confirm('Approve this vendor application?')) return;
      
      try {
        await db.collection('users').doc(vendorId).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('Vendor approved successfully');
        await loadDashboard(); // Reload dashboard data
        
      } catch (error) {
        console.error('Error approving vendor:', error);
        showAlert('Failed to approve vendor', 'error');
      }
    }

    async function rejectVendor(vendorId) {
      if (!confirm('Reject this vendor application?')) return;
      
      try {
        await db.collection('users').doc(vendorId).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('Vendor application rejected');
        await loadDashboard(); // Reload dashboard data
        
      } catch (error) {
        console.error('Error rejecting vendor:', error);
        showAlert('Failed to reject vendor', 'error');
      }
    }

    async function deleteProduct(productId) {
      if (!confirm('Delete this product? This action cannot be undone.')) return;
      
      try {
        await db.collection('products').doc(productId).delete();
        showAlert('Product deleted successfully');
        await loadDashboard(); // Reload dashboard data
        
      } catch (error) {
        console.error('Error deleting product:', error);
        showAlert('Failed to delete product', 'error');
      }
    }

    // ====== AUTH STATE MANAGEMENT ======
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not logged in, redirect to admin auth
        window.location.href = 'admin-auth.html';
        return;
      }
      
      try {
        // Check if user is admin
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists || userDoc.data().role !== 'admin') {
          showAlert('Access denied. Admin account required.', 'error');
          await auth.signOut();
          setTimeout(() => window.location.href = 'admin-auth.html', 2000);
          return;
        }
        
        // User is admin, set up dashboard
        currentAdmin = user;
        document.getElementById('admin-name').textContent = userDoc.data().name || 'Admin';
        loadDashboard();
        
      } catch (error) {
        console.error('Error checking admin status:', error);
        showAlert('Error verifying admin access', 'error');
      }
    });

    // ====== INITIALIZATION ======
    document.addEventListener('DOMContentLoaded', () => {
      // Set up event listeners for quick action buttons
      document.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const text = e.target.closest('button').querySelector('span').nextSibling.textContent;
          const tabName = text.trim().split(' ')[1].toLowerCase();
          showTab(tabName);
        });
      });
    });
  </script>
</body>
</html>